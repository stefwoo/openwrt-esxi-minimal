name: Build OpenWrt 24.10 for ESXi - Minimal

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt version tag'
        required: true
        default: 'v24.10.0'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        df -h
      
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget \
          python3-dev python3-pip qemu-utils libelf-dev
      
    - name: Clone OpenWrt
      run: |
        OPENWRT_VER="${{ github.event.inputs.openwrt_version }}"
        echo "=== 尝试从 GitHub 镜像克隆 ==="
        if git clone --depth 1 --branch "$OPENWRT_VER" https://github.com/openwrt/openwrt.git openwrt; then
          echo "GitHub 镜像克隆成功"
        else
          echo "=== GitHub 失败，尝试官方源 ==="
          if git clone --depth 1 --branch "$OPENWRT_VER" https://git.openwrt.org/openwrt/openwrt.git openwrt; then
            echo "官方源克隆成功"
          else
            echo "=== 官方源失败，尝试 Gitee 镜像 ==="
            if git clone --depth 1 --branch "$OPENWRT_VER" https://gitee.com/openwrt-mirrors/openwrt.git openwrt; then
              echo "Gitee 镜像克隆成功"
            else
              echo "所有源均失败！"
              exit 1
            fi
          fi
        fi
      
    - name: Update and Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
      
    - name: Copy Configuration Files
      run: |
        cd openwrt
        cp $GITHUB_WORKSPACE/config.seed .config
        mkdir -p files/etc/uci-defaults
        cp $GITHUB_WORKSPACE/files/99-custom-network files/etc/uci-defaults/
        cp $GITHUB_WORKSPACE/files/99-firstboot files/etc/uci-defaults/
        chmod +x files/etc/uci-defaults/*
      
    - name: Configure Build
      run: |
        cd openwrt
        make defconfig
      
    - name: Download Sources
      run: |
        cd openwrt
        make download -j8 || make download -j1 V=s
      
    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
        
    - name: Upload All Firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-all
        path: |
          openwrt/bin/targets/x86/64/*
        retention-days: 7
