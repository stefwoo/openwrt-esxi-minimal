name: Build OpenWrt 24.10 for ESXi - Minimal

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt version tag'
        required: true
        default: 'v24.10.5'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        df -h
      
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget \
          python3-dev python3-pip qemu-utils libelf-dev
      
    - name: Clone OpenWrt
      run: |
        OPENWRT_VER="${{ github.event.inputs.openwrt_version }}"
        
        # 尝试多个源克隆OpenWrt
        echo "=== 尝试从 GitHub 镜像克隆 ==="
        if git clone --depth 1 --branch "$OPENWRT_VER" https://github.com/openwrt/openwrt.git openwrt; then
          echo "GitHub 镜像克隆成功"
        else
          echo "=== GitHub 失败，尝试官方源 ==="
          if git clone --depth 1 --branch "$OPENWRT_VER" https://git.openwrt.org/openwrt/openwrt.git openwrt; then
            echo "官方源克隆成功"
          else
            echo "=== 官方源失败，尝试 Gitee 镜像 ==="
            if git clone --depth 1 --branch "$OPENWRT_VER" https://gitee.com/openwrt-mirrors/openwrt.git openwrt; then
              echo "Gitee 镜像克隆成功"
            else
              echo "所有源均失败！"
              exit 1
            fi
          fi
        fi
        
        cd openwrt
        echo "OpenWrt 版本: $(git describe --tags 2>/dev/null || echo $OPENWRT_VER)"
      
    - name: Update and Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
      
    - name: Copy Configuration Files
      run: |
        cd openwrt
        # 复制config
        cp $GITHUB_WORKSPACE/config.seed .config
        # 复制网络配置脚本
        mkdir -p files/etc/uci-defaults
        cp $GITHUB_WORKSPACE/files/99-custom-network files/etc/uci-defaults/
        cp $GITHUB_WORKSPACE/files/99-firstboot files/etc/uci-defaults/
        chmod +x files/etc/uci-defaults/*
      
    - name: Configure Build
      run: |
        cd openwrt
        make defconfig
      
    - name: Download Sources
      run: |
        cd openwrt
        make download -j8 || make download -j1 V=s
      
    - name: Compile Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s
      
    - name: Prepare VMDK Files
      run: |
        cd openwrt/bin/targets/x86/64/
        
        # 查找并解压镜像
        for f in *.img.gz; do
          [ -f "$f" ] && gzip -d "$f"
        done
        
        # 转换为VMDK
        IMG_FILE=$(ls *-ext4-combined-efi.img 2>/dev/null | head -1)
        if [ -n "$IMG_FILE" ] && [ -f "$IMG_FILE" ]; then
          echo "找到镜像: $IMG_FILE"
          qemu-img convert -f raw -O vmdk "$IMG_FILE" openwrt-esxi-flat.vmdk
          
          # 创建VMDK描述符
          SIZE=$(stat -c%s openwrt-esxi-flat.vmdk)
          SECTORS=$((SIZE / 512))
          
          cat > openwrt-esxi.vmdk <<EOF
# Disk DescriptorFile
version=1
CID=fffffffe
parentCID=ffffffff
createType="monolithicFlat"

# Extent description
RW ${SECTORS} FLAT "openwrt-esxi-flat.vmdk" 0

# The Disk Data Base
#DDB

ddb.adapterType = "lsilogic"
ddb.geometry.cylinders = "522"
ddb.geometry.heads = "255"
ddb.geometry.sectors = "63"
ddb.virtualHWVersion = "14"
EOF
          echo "VMDK 创建成功"
        else
          echo "未找到镜像文件"
          ls -la
        fi
      
    - name: Upload VMDK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-esxi-vmdk
        path: |
          openwrt/bin/targets/x86/64/*.vmdk
        retention-days: 7
        
    - name: Upload All Firmware
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-all
        path: |
          openwrt/bin/targets/x86/64/*
        retention-days: 7
